# Copilot instructions for this repo

Purpose: help AI agents be productive immediately in this Electron + React + Drizzle + Supabase codebase.

## Big picture
- Three processes with strict boundaries:
  - Main (`src/main`): Electron lifecycle, per-user SQLite DB (better-sqlite3 + Drizzle), IPC handlers.
  - Preload (`src/preload`): Safe bridge with `contextBridge` exposing `window.api.db` methods; types in `src/preload/index.d.ts`.
  - Renderer (`src/renderer/src`): React app (TanStack Router/Query, Zustand, shadcn + Tailwind).
- Auth is Supabase (public anon key) in the renderer; on login/logout the renderer initializes/closes a user-specific DB in the main process via IPC.

## Data and IPC flow
- DB isolation per user:
  - Main DB module: `src/main/db/index.ts` exports `initializeUserDatabase(userId)`, `closeCurrentDatabase()`, `getDatabase()`, `getCurrentUserId()`.
  - IPC setup: see `src/main/index.ts` handlers `db:initializeUser`, `db:closeUser`, `db:getCurrentUser`.
  - Preload wraps IPC in `window.api.db.{initializeUser,closeUser,getCurrentUser}`.
  - Renderer triggers DB lifecycle in `src/renderer/src/stores/auth-store.ts` (on login/register/logout/checkAuth).
- Pattern for app data access:
  - Add IPC in main using `getDatabase()` and tables from `src/main/db/schema.ts`.
  - Expose it in preload and declare types in `src/preload/index.d.ts`.
  - Call from renderer via `window.api...` (do not import Node/Electron or better-sqlite3 in the renderer).

## Builds, run, and migrations
- Dev: `npm run dev` (electron-vite for main/preload/renderer; alias `@` -> `src/renderer/src`).
- Typecheck: `npm run typecheck` (separate Node/Web tsconfigs).
- Package: `npm run build:win|mac|linux` (electron-builder). Migrations bundled via `electron-builder.yml` `extraResources` and copied to `out/main/drizzle` in dev by `copy-drizzle-migrations` plugin in `electron.vite.config.ts`.
- Drizzle workflows:
  - Edit schema in `src/main/db/schema.ts`.
  - Generate/apply: `npm run db:generate` then `npm run db:migrate` (or `db:push` for dev).
  - Migration runner: `src/main/db/migrate.ts` resolves migrations from `__dirname/drizzle`, `process.resourcesPath/drizzle`, or `app.getAppPath()/drizzle`.

## Renderer architecture/conventions
- Entry: `src/renderer/src/main.tsx`; routes are generated by TanStack Router plugin to `routeTree.gen.ts`. Add routes under `src/renderer/src/routes`, don’t edit the generated file.
- Query/Errors: global `QueryClient` in `main.tsx` redirects to `/sign-in-2` on 401 and `/500` on 500; use Axios; follow this pattern for errors.
- State: Zustand in `src/renderer/src/stores`. UI: shadcn components under `src/renderer/src/components`.
- Env: use `import.meta.env.VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` in the renderer (never `process.env`).

## Main/preload conventions
- Keep all DB and filesystem access in the main process. Any DB call before login will throw (“No database initialized”).
- When adding IPC, always:
  1) register a channel in `src/main/index.ts`,
  2) expose a method in `src/preload/index.ts`,
  3) extend types in `src/preload/index.d.ts`.

## Examples (concise)
- Main IPC using Drizzle:
  - `ipcMain.handle('db:getUserPrefs', () => getDatabase().select().from(userPreferencesTable))` in `src/main/index.ts`.
  - Expose `window.api.db.getUserPrefs()` in preload/types, then call it from the renderer.

### Tiny end-to-end example (all 3 layers)
- Main (`src/main/index.ts`):
  - `import { getDatabase } from './db'`
  - `import { userPreferencesTable } from './db/schema'`
  - `ipcMain.handle('db:getUserPrefs', () => getDatabase().select().from(userPreferencesTable))`
- Preload (`src/preload/index.ts`): add under `api.db`
  - `getUserPrefs: () => ipcRenderer.invoke('db:getUserPrefs')`
- Types (`src/preload/index.d.ts`): extend `DatabaseAPI`
  - `getUserPrefs: () => Promise<any[]>`
- Renderer usage (after auth so DB is initialized):
  - `const prefs = await window.api.db.getUserPrefs()`

## Gotchas
- Native module: if better-sqlite3 errors (NODE_MODULE_VERSION), rebuild for Electron (postinstall already runs `electron-rebuild`).
- External links: main blocks new windows and opens external via `setWindowOpenHandler`.
- Devtools/shortcuts: managed by `@electron-toolkit/utils` (`optimizer.watchWindowShortcuts`).

## Pointers to key files
- Build: `electron.vite.config.ts`, `electron-builder.yml`, `package.json` scripts.
- DB: `src/main/db/{schema.ts,index.ts,migrate.ts}` and `drizzle/` migrations.
- Auth/DB lifecycle glue: `src/main/index.ts`, `src/preload/index.ts`, `src/renderer/src/stores/auth-store.ts`.
- Renderer bootstrap: `src/renderer/src/main.tsx`, `src/renderer/src/routeTree.gen.ts` (generated).